# X "为你推荐" Feed 算法

本仓库包含驱动 X 平台"For You"（为你推荐）信息流的核心推荐系统。它结合了站内内容（来自你关注的账号）和站外内容（通过基于机器学习的检索发现），并使用基于 Grok 的 Transformer 模型对所有内容进行排序。

> **注意：** Transformer 实现移植自 xAI 的 [Grok-1 开源版本](https://github.com/xai-org/grok-1)，并针对推荐系统用例进行了适配。

## 目录

- [概述](#概述)
- [系统架构](#系统架构)
- [组件](#组件)
  - [Home Mixer](#home-mixer)
  - [Thunder](#thunder)
  - [Phoenix](#phoenix)
  - [Candidate Pipeline](#candidate-pipeline)
- [工作原理](#工作原理)
  - [管道阶段](#管道阶段)
  - [打分和排序](#打分和排序)
  - [过滤](#过滤)
- [关键设计决策](#关键设计决策)
- [许可证](#许可证)

---

## 概述

"For You" Feed 算法从两个来源检索、排序和过滤帖子：

1. **站内内容（Thunder）**：来自你关注的账号的帖子
2. **站外内容（Phoenix Retrieval）**：从全局语料库中发现的内容

两个来源的内容被合并在一起，使用 **Phoenix**（一个基于 Grok 的 Transformer 模型）进行排序，该模型预测每个帖子的交互概率。最终分数是这些预测交互的加权组合。

我们已经从系统中消除了所有手工设计的特征和大部分启发式规则。基于 Grok 的 Transformer 通过理解你的交互历史（你点赞、回复、分享的内容等）来完成所有繁重的工作，并使用这些信息来确定哪些内容与你相关。

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    "为你推荐" FEED 请求                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         HOME MIXER                                          │
│                                    (编排层)                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   查询增强                                           │   │
│   │  ┌──────────────────────────┐    ┌──────────────────────────────────────────────┐   │   │
│   │  │ 用户交互序列              │    │ 用户特征                                      │   │   │
│   │  │ (交互历史)                │    │ (关注列表、偏好设置等)                        │   │   │
│   │  └──────────────────────────┘    └──────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                  候选来源                                            │   │
│   │         ┌─────────────────────────────┐    ┌────────────────────────────────┐       │   │
│   │         │        THUNDER              │    │     PHOENIX 检索              │       │   │
│   │         │    (站内帖子)               │    │   (站外帖子)                   │       │   │
│   │         │                             │    │                                │       │   │
│   │         │  来自你关注的账号的帖子      │    │  基于ML的相似度搜索            │       │   │
│   │         │                             │    │  在全局语料库中搜索            │       │   │
│   │         └─────────────────────────────┘    └────────────────────────────────┘       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     数据增强                                         │   │
│   │  获取额外数据：帖子核心元数据、作者信息、媒体实体等                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     过滤                                            │   │
│   │  移除：重复、旧帖子、自己的帖子、屏蔽的作者、静音关键词等                            │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                      打分                                           │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Phoenix 打分器           │    基于 Grok 的 Transformer 预测：                     │   │
│   │  │  (ML 预测)               │    P(点赞), P(回复), P(转发), P(点击)...                │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  加权打分器              │    加权分数 = Σ (权重 × P(动作))                        │   │
│   │  │  (组合预测)              │                                                       │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  作者多样性打分器         │    衰减重复作者的分数                                 │   │
│   │  │                          │    以确保 Feed 多样性                                 │   │
│   │  └──────────────────────────┘                                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                     选择                                            │   │
│   │                    按最终分数排序，选择 Top K 候选                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              过滤（选择后）                                         │   │
│   │                 可见性过滤（已删除/垃圾/暴力/血腥等）                                │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     排序后的 Feed 响应                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 组件

### Home Mixer

**位置：** [`home-mixer/`](home-mixer/)

组装"For You" Feed 的编排层。它利用 `CandidatePipeline` 框架，包含以下阶段：

| 阶段 | 描述 |
|-------|-------------|
| Query Hydrators（查询增强器） | 获取用户上下文（交互历史、关注列表） |
| Sources（来源） | 从 Thunder 和 Phoenix 检索候选 |
| Hydrators（增强器） | 用额外数据丰富候选 |
| Filters（过滤器） | 移除不符合条件的候选 |
| Scorers（打分器） | 预测交互并计算最终分数 |
| Selector（选择器） | 按分数排序并选择 Top K |
| Post-Selection Filters（选择后过滤器） | 最终的可见性和去重检查 |
| Side Effects（副作用） | 缓存请求信息供将来使用 |

服务器暴露一个 gRPC 端点（`ScoredPostsService`），为给定用户返回排序后的帖子。

---

### Thunder

**位置：** [`thunder/`](thunder/)

一个内存中的帖子存储和实时摄取管道，跟踪所有用户最近的帖子。它：

- 从 Kafka 消费帖子创建/删除事件
- 为每个用户维护原始帖子、回复/转发和视频帖子的存储
- 从请求用户关注的账号提供"站内"帖子候选
- 自动清理超过保留期的帖子

Thunder 实现了亚毫秒级的站内内容查询，无需访问外部数据库。

---

### Phoenix

**位置：** [`phoenix/`](phoenix/)

具有两个主要功能的 ML 组件：

#### 1. 检索（Two-Tower 模型）
查找相关的站外帖子：
- **User Tower（用户塔）**：将用户特征和交互历史编码为嵌入向量
- **Candidate Tower（候选塔）**：将所有帖子编码为嵌入向量
- **相似度搜索**：通过点积相似度检索 Top-K 帖子

#### 2. 排序（带候选隔离的 Transformer）
预测每个候选的交互概率：
- 将用户上下文（交互历史）和候选帖子作为输入
- 使用特殊的注意力掩码，使候选之间不能相互关注
- 输出每种动作类型的概率（点赞、回复、转发、点击等）

详细架构文档请参见 [`phoenix/README.md`](phoenix/README.md)。

---

### Candidate Pipeline

**位置：** [`candidate-pipeline/`](candidate-pipeline/)

用于构建推荐管道的可重用框架。定义了以下 Trait：

| Trait | 用途 |
|-------|---------|
| `Source` | 从数据源获取候选 |
| `Hydrator` | 用额外特征丰富候选 |
| `Filter` | 移除不应该显示的候选 |
| `Scorer` | 计算排序分数 |
| `Selector` | 排序并选择 Top 候选 |
| `SideEffect` | 运行异步副作用（缓存、日志） |

该框架尽可能并行运行 sources 和 hydrators，具有可配置的错误处理和日志记录。

---

## 工作原理

### 管道阶段

1. **Query Hydration（查询增强）**：获取用户最近的交互历史和元数据（例如关注列表）

2. **Candidate Sourcing（候选获取）**：从以下来源检索候选：
   - **Thunder**：来自关注账号的最近帖子（站内）
   - **Phoenix Retrieval**：从全局语料库中发现的 ML 帖子（站外）

3. **Candidate Hydration（候选增强）**：用以下内容丰富候选：
   - 帖子核心数据（文本、媒体等）
   - 作者信息（用户名、认证状态）
   - 视频时长（针对视频帖子）
   - 订阅状态

4. **Pre-Scoring Filters（打分前过滤）**：移除以下帖子：
   - 重复的
   - 太旧的
   - 来自查看者自己的
   - 来自屏蔽/静音账号的
   - 包含静音关键词的
   - 之前看过或最近服务过的
   - 不符合条件的订阅内容

5. **Scoring（打分）**：顺序应用多个打分器：
   - **Phoenix Scorer**：从 Phoenix Transformer 模型获取 ML 预测
   - **Weighted Scorer**：将预测组合成最终的相关性分数
   - **Author Diversity Scorer**：衰减重复作者的分数以确保多样性
   - **OON Scorer**：调整站外内容的分数

6. **Selection（选择）**：按分数排序并选择 Top K 候选

7. **Post-Selection Processing（选择后处理）**：对要服务的帖子候选进行最终验证

---

### 打分和排序

Phoenix 基于 Grok 的 Transformer 模型预测多种交互类型的概率：

```
预测：
├── P(点赞)
├── P(回复)
├── P(转发)
├── P(引用)
├── P(点击)
├── P(个人资料点击)
├── P(视频观看)
├── P(照片展开)
├── P(分享)
├── P(停留)
├── P(关注作者)
├── P(不感兴趣)
├── P(屏蔽作者)
├── P(静音作者)
└── P(举报)
```

**加权打分器**将这些组合成最终分数：

```
最终分数 = Σ (weight_i × P(action_i))
```

正面动作（点赞、转发、分享）具有正权重。负面动作（屏蔽、静音、举报）具有负权重，降低用户可能不喜欢的内容的分数。

---

### 过滤

过滤器在两个阶段运行：

**打分前过滤器：**
| 过滤器 | 用途 |
|--------|---------|
| `DropDuplicatesFilter` | 移除重复的帖子 ID |
| `CoreDataHydrationFilter` | 移除核心元数据获取失败的帖子 |
| `AgeFilter` | 移除超过阈值的旧帖子 |
| `SelfpostFilter` | 移除用户自己的帖子 |
| `RepostDeduplicationFilter` | 对相同内容的转发去重 |
| `IneligibleSubscriptionFilter` | 移除用户无法访问的付费内容 |
| `PreviouslySeenPostsFilter` | 移除用户已经看过的帖子 |
| `PreviouslyServedPostsFilter` | 移除会话中已服务的帖子 |
| `MutedKeywordFilter` | 移除包含用户静音关键词的帖子 |
| `AuthorSocialgraphFilter` | 移除来自屏蔽/静音作者的帖子 |

**选择后过滤器：**
| 过滤器 | 用途 |
|--------|---------|
| `VFFilter` | 移除已删除/垃圾/暴力/血腥等的帖子 |
| `DedupConversationFilter` | 对同一对话线程的多个分支去重 |

---

## 关键设计决策

### 1. 无手工特征工程
系统完全依赖基于 Grok 的 Transformer 从用户交互序列中学习相关性。没有针对内容相关性的手动特征工程。这显著降低了我们数据管道和服务基础设施的复杂性。

### 2. 排序中的候选隔离
在 Transformer 推理期间，候选之间不能相互关注——只能关注用户上下文。这确保帖子的分数不依赖于批次中的其他帖子，使分数一致且可缓存。

### 3. 基于哈希的嵌入
检索和排序都使用多个哈希函数进行嵌入查找

### 4. 多动作预测
不是预测单一的"相关性"分数，模型预测多种动作的概率。

### 5. 可组合的管道架构
`candidate-pipeline` crate 提供了一个灵活的框架，用于构建推荐管道，具有：
- 管道执行和监控与业务逻辑的分离
- 独立阶段的并行执行和优雅的错误处理
- 易于添加新的 sources、hydrations、filters 和 scorers

---

## 许可证

本项目采用 Apache License 2.0 许可证。详情请参见 [LICENSE](LICENSE) 文件。
